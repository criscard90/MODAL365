class Modal365{constructor(e){this.modal=document.createElement("div"),this.modal.style.width="50%",this.modal.style.position="fixed",this.modal.style.top="50%",this.modal.style.left="50%",this.modal.style.transform="translate(-50%, -50%)",this.modal.style.backgroundColor="white",this.modal.style.padding="30px",this.modal.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.5)",this.modal.style.zIndex="1000";let t=document.createElement("h2");t.textContent=e.title,t.style.marginBottom="20px",this.modal.appendChild(t),this.inputs={},e.inputs.forEach(e=>{let t=document.createElement("label");t.textContent=e.label,t.style.display="block",t.style.marginBottom="5px";let a=document.createElement("input");a.type="text",a.style.display="block",a.style.marginBottom="20px",this.inputs[e.label]=a,this.modal.appendChild(t),this.modal.appendChild(a)});let a=document.createElement("button");a.textContent=e.executeButtonText,a.style.display="inline",a.style.marginTop="20px",this.modal.executeButton=a,this.modal.appendChild(a);let s=document.createElement("button");s.textContent="Chiudi",s.style.display="inline",s.style.marginTop="10px",s.style.marginLeft="10px",s.onclick=()=>document.body.removeChild(this.modal),this.modal.appendChild(s);let i=document.createElement("div");i.style.width="100%",i.style.backgroundColor="#e0e0e0",i.style.marginTop="20px",i.style.marginBottom="10px";let n=document.createElement("div");n.style.width="0%",n.style.height="20px",n.style.backgroundColor="#76c7c0",i.appendChild(n),this.modal.appendChild(i);let o=document.createElement("div");o.style.marginTop="10px",o.innerText="Pronto",this.modal.appendChild(o);let l=document.createElement("div");l.style.height="150px",l.style.marginTop="10px",l.style.maxHeight="150px",l.style.overflowY="auto",l.style.border="1px solid #ccc",l.style.padding="10px",this.modal.appendChild(l),document.body.appendChild(this.modal),this.progressSteps=e.progressSteps,this.logContainer=l,this.modal.executeButton.onclick=()=>{let e={};for(let t in this.inputs)e[t]=this.inputs[t].value;this.mainThread(e)},MODAL365.Utility.loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js")}async mainThread(e){let t=0;for(let a of(this.logContainer.innerHTML="",this.progressSteps))await a.operation(e),t+=a.percentage,this.modal.querySelector("div > div").style.width=`${t}%`,this.modal.querySelector("div > div").style.backgroundColor="#00c98c",this.modal.querySelector("div > div + div").textContent=a.label}}Modal365.Utility=class{static async loadScript(e){let t=await (await fetch(e)).text(),a=document.createElement("script");a.textContent=t,document.head.appendChild(a)}static async await(e){return new Promise(t=>setTimeout(t,e))}static createLogEntry(e,t){let a=document.createElement("div");a.textContent=e,a.style.marginTop="5px",a.style.color="#333",t.appendChild(a),t.scrollTop=t.scrollHeight}static async backupRecord(e,t){try{if(!e||!t){alert("Impossibile ottenere ID o entit\xe0 dalla pagina corrente.");return}let a=Xrm.Utility.getGlobalContext().getClientUrl(),s=`${a}/api/data/v9.2/${e}s(${t})`,i=await fetch(s,{method:"GET",headers:{Accept:"application/json","OData-MaxVersion":"4.0","OData-Version":"4.0"}}).then(e=>e.json()),n=`${a}/api/data/v9.2/EntityDefinitions(LogicalName='${e}')?$expand=OneToManyRelationships`,o=await fetch(n,{method:"GET",headers:{Accept:"application/json","OData-MaxVersion":"4.0","OData-Version":"4.0"}}).then(e=>e.json()),l=o.OneToManyRelationships;if(!l||0===l.length){alert("Nessuna relazione 1:N trovata per questa entit\xe0.");return}let r=XLSX.utils.book_new(),d=XLSX.utils.json_to_sheet([i]);for(let p of(XLSX.utils.book_append_sheet(r,d,"Main Record"),l)){let c=p.ReferencedEntityNavigationPropertyName,u=p.ReferencingEntity;if(console.log(c),c){let h=`${a}/api/data/v9.2/${e}s(${t})/${c}`,y=await fetch(h,{method:"GET",headers:{Accept:"application/json","OData-MaxVersion":"4.0","OData-Version":"4.0"}}).then(e=>e.json());if(y&&y.value&&y.value.length>0){let $=XLSX.utils.json_to_sheet(y.value);XLSX.utils.book_append_sheet(r,$,u.substring(0,30))}}}XLSX.writeFile(r,`${e}_${t}_backup.xlsx`)}catch(m){console.error("Errore durante il backup:",m),alert("Si \xe8 verificato un errore. Controlla la console per maggiori dettagli.")}}},Modal365.CRUD=class{static async executeRetrieve(e,t){let a=Xrm.Utility.getGlobalContext().getClientUrl()+"/api/data/v9.2/"+e+t,s=new XMLHttpRequest;return s.open("GET",a,!0),s.setRequestHeader("OData-MaxVersion","4.0"),s.setRequestHeader("OData-Version","4.0"),s.setRequestHeader("Accept","application/json"),s.setRequestHeader("Prefer",'odata.include-annotations="OData.Community.Display.V1.FormattedValue"'),new Promise((e,t)=>{s.onload=()=>{200===s.status||201===s.status?e(JSON.parse(s.responseText).value):t(Error("Error in API request"))},s.onerror=()=>t(Error("Error in API request"));try{s.send()}catch(a){t(a)}})}static async executeCreate(e,t){let a=Xrm.Utility.getGlobalContext().getClientUrl()+"/api/data/v9.2/"+e+"s",s=new XMLHttpRequest;return s.open("POST",a,!0),s.setRequestHeader("OData-MaxVersion","4.0"),s.setRequestHeader("OData-Version","4.0"),s.setRequestHeader("Accept","application/json"),s.setRequestHeader("Content-Type","application/json; charset=utf-8"),new Promise((e,a)=>{s.onload=()=>{200===s.status||201===s.status?e(JSON.parse(s.responseText)):a(Error("Error in API request"))},s.onerror=()=>a(Error("Error in API request"));try{s.send(JSON.stringify(t))}catch(i){a(i)}})}static async executeDelete(e,t){let a=Xrm.Utility.getGlobalContext().getClientUrl()+"/api/data/v9.2/"+e+"s("+t+")",s=new XMLHttpRequest;return s.open("DELETE",a,!0),s.setRequestHeader("OData-MaxVersion","4.0"),s.setRequestHeader("OData-Version","4.0"),s.setRequestHeader("Accept","application/json"),new Promise((e,t)=>{s.onload=()=>{204===s.status?e(!0):t(Error("Error in API request"))},s.onerror=()=>t(Error("Error in API request"));try{s.send()}catch(a){t(a)}})}static async executeUpdate(e,t,a){let s=Xrm.Utility.getGlobalContext().getClientUrl()+"/api/data/v9.2/"+e+"s("+t+")",i=new XMLHttpRequest;return i.open("PATCH",s,!0),i.setRequestHeader("OData-MaxVersion","4.0"),i.setRequestHeader("OData-Version","4.0"),i.setRequestHeader("Accept","application/json"),i.setRequestHeader("Content-Type","application/json; charset=utf-8"),new Promise((e,t)=>{i.onload=()=>{200===i.status||204===i.status?e(!0):t(Error("Error in API request"))},i.onerror=()=>t(Error("Error in API request"));try{i.send(JSON.stringify(a))}catch(s){t(s)}})}};export default Modal365;
